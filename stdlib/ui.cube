native stdlib/libs/libui
{
    void ui_start();
    void ui_stop();
    num ui_create_window(str, num, num);
    void ui_destroy_window(num);
    list ui_run_cycle();
    void ui_run_forever();
    bool ui_has_quit();
    bool ui_load(num, str);
    bool ui_on_event(num, str, str);
    dict ui_get_event_args(str);
    list ui_get_property(num, str, str);
    bool ui_set_property(num, str, str, str);
    dict ui_get_obj(num, str);
}

class UI
{
    static var windows = [];

    static func start()
    {
        ui_start();
    }

    static func stop()
    {
        ui_stop();
    }

    static func forever()
    {
        while(UI.running())
        {
            UI.cycle();
            wait(16);
            // println(mem(true));
        }
        UI.stop();
    }

    static func cycle()
    {
        var events = ui_run_cycle();
        for(var i = 0; i < len(events); ++i)
        {
            var ev = events[i];
            var parts = ev.split(':');
            var id = num(parts[0]);
            var obj = parts[1];
            var event = parts[2];
            var target = parts[3];
            for(var j = 0; j < len(UI.windows); ++j)
            {
                var window = UI.windows[j];
                if(window.id == id)
                {
                    var onId = '{}:{}'.format(obj, event);
                    if(window.actions.exists(onId))
                    {
                        var action = window.actions.get(onId, none);
                        var evArgs = ui_get_event_args(ev);
                        action(window, target, evArgs);
                    }
                }
            }
        }
        return true;
    }

    static func running()
    {
        return !ui_has_quit();
    }

    static func addWindow(w)
    {
        UI.windows.add(w);
    }

    static func removeWindow(w)
    {
        UI.windows.remove(w);
    }
}

class Window
{
    var id = none;
    var actions = {};

    func init(name, width, height)
    {
        this.id = ui_create_window(name, width, height);
        UI.addWindow(this);
    }

    func close()
    {
        ui_destroy_window(this.id);
        UI.removeWindow(this);
    }

    func load(fileName)
    {
        return ui_load(this.id, fileName);
    }

    func on(obj, event, action)
    {
        var onId = '{}:{}'.format(obj, event);
        this.actions[onId] = action;

        return ui_on_event(this.id, obj, event);
    }

    func obj(name)
    {
        return ui_get_obj(this.id, name);
    }

    func get(obj, prop)
    {
        return ui_get_property(this.id, obj, prop);
    }

    func set(obj, prop, value)
    {
        return ui_set_property(this.id, obj, prop, value);
    }
}